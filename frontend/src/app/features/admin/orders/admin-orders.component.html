<div class="admin-orders">
    <div class="page-header">
        <h1>Qu·∫£n l√Ω ƒë∆°n h√†ng</h1>
        <div class="filters">
            <select [(ngModel)]="statusFilter" (change)="filterOrders()">
                <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
                <option value="Pending">Ch·ªù x·ª≠ l√Ω</option>
                <option value="Processing">ƒêang x·ª≠ l√Ω</option>
                <option value="Shipped">ƒêang giao</option>
                <option value="Delivered">ƒê√£ giao</option>
                <option value="Cancelled">ƒê√£ h·ªßy</option>
            </select>
        </div>
    </div>

    <!-- Orders Table -->
    <div class="table-container">
        @if (loading()) {
        <div class="loading">ƒêang t·∫£i...</div>
        } @else {
        <table class="data-table">
            <thead>
                <tr>
                    <th>M√£ ƒë∆°n</th>
                    <th>Ng√†y ƒë·∫∑t</th>
                    <th>Kh√°ch h√†ng</th>
                    <th>T·ªïng ti·ªÅn</th>
                    <th>Tr·∫°ng th√°i</th>
                </tr>
            </thead>
            <tbody>
                @for (order of filteredOrders(); track order.id) {
                <tr class="clickable-row" (click)="viewOrder(order)">
                    <td class="order-id">#{{ order.id }}</td>
                    <td>{{ order.orderDate | date:'dd/MM/yyyy HH:mm' }}</td>
                    <td>
                        <span class="customer-info" title="User ID: {{order.userId}}">
                            {{ userMap().get(order.userId) || 'Kh√°ch h√†ng #' + order.userId }}
                        </span>
                    </td>
                    <td class="price">{{ order.totalAmount | number:'1.0-0' }}ƒë</td>
                    <td>
                        <div class="status-actions" (click)="$event.stopPropagation()">
                            <button class="btn-icon delete" (click)="confirmDelete(order)" title="X√≥a ƒë∆°n h√†ng">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <polyline points="3 6 5 6 21 6"></polyline>
                                    <path
                                        d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2">
                                    </path>
                                </svg>
                            </button>
                            <select class="status-select" [(ngModel)]="order.orderStatus"
                                (change)="updateStatus(order)">
                                <option value="Pending">Ch·ªù x·ª≠ l√Ω</option>
                                <option value="Processing">ƒêang x·ª≠ l√Ω</option>
                                <option value="Shipped">ƒêang giao</option>
                                <option value="Delivered">ƒê√£ giao</option>
                                <option value="Cancelled">ƒê√£ h·ªßy</option>
                            </select>
                        </div>
                    </td>
                </tr>
                } @empty {
                <tr>
                    <td colspan="5" class="empty">Kh√¥ng c√≥ ƒë∆°n h√†ng n√†o</td>
                </tr>
                }
            </tbody>
        </table>
        }
    </div>

    <!-- Order Detail Modal -->
    @if (showOrderDetailModal && selectedOrder) {
    <div class="modal-overlay" (click)="closeOrderDetail()">
        <div class="modal order-detail-modal" (click)="$event.stopPropagation()">
            <div class="modal-header">
                <h2>Chi ti·∫øt ƒë∆°n h√†ng #{{ selectedOrder.id }}</h2>
                <button class="close-btn" (click)="closeOrderDetail()">√ó</button>
            </div>
            <div class="modal-body">
                <!-- Customer Info -->
                <div class="customer-section">
                    <h3>üßë Th√¥ng tin kh√°ch h√†ng</h3>
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="label">Ng∆∞·ªùi nh·∫≠n:</span>
                            <span class="value">{{ selectedOrder.recipientName || userMap().get(selectedOrder.userId) ||
                                'N/A' }}</span>
                        </div>
                        <div class="info-item">
                            <span class="label">S·ªë ƒëi·ªán tho·∫°i:</span>
                            <span class="value">{{ selectedOrder.phone || 'N/A' }}</span>
                        </div>
                        <div class="info-item full-width">
                            <span class="label">ƒê·ªãa ch·ªâ:</span>
                            <span class="value">{{ selectedOrder.streetAddress || 'N/A' }}{{ selectedOrder.city ? ', ' +
                                selectedOrder.city : '' }}</span>
                        </div>
                    </div>
                </div>

                <!-- Order Items -->
                <div class="items-section">
                    <h3>üì¶ S·∫£n ph·∫©m ({{ selectedOrder.orderItems?.length || 0 }})</h3>
                    <table class="items-table">
                        <thead>
                            <tr>
                                <th>S·∫£n ph·∫©m</th>
                                <th>ƒê∆°n gi√°</th>
                                <th>S·ªë l∆∞·ª£ng</th>
                                <th>Th√†nh ti·ªÅn</th>
                            </tr>
                        </thead>
                        <tbody>
                            @for (item of selectedOrder.orderItems; track item.productId) {
                            <tr>
                                <td>{{ item.productName || 'S·∫£n ph·∫©m #' + item.productId }}</td>
                                <td>{{ (item.price || item.unitPrice || 0) | number:'1.0-0' }}ƒë</td>
                                <td>{{ item.quantity }}</td>
                                <td class="item-total">{{ ((item.price || item.unitPrice || 0) * item.quantity) |
                                    number:'1.0-0' }}ƒë</td>
                            </tr>
                            } @empty {
                            <tr>
                                <td colspan="4" class="empty">Kh√¥ng c√≥ s·∫£n ph·∫©m</td>
                            </tr>
                            }
                        </tbody>
                    </table>
                </div>

                <!-- Order Summary -->
                <div class="order-summary">
                    <div class="summary-row">
                        <span>Ng√†y ƒë·∫∑t:</span>
                        <span>{{ selectedOrder.orderDate | date:'dd/MM/yyyy HH:mm' }}</span>
                    </div>
                    <div class="summary-row">
                        <span>Tr·∫°ng th√°i:</span>
                        <span class="status-badge" [class]="getStatusClass(selectedOrder.orderStatus)">
                            {{ getStatusLabel(selectedOrder.orderStatus) }}
                        </span>
                    </div>
                    <div class="summary-row total">
                        <span>T·ªïng ti·ªÅn:</span>
                        <span class="total-price">{{ selectedOrder.totalAmount | number:'1.0-0' }}ƒë</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    }

    <!-- Delete Confirmation Modal -->
    @if (showDeleteModal) {
    <div class="modal-overlay" (click)="showDeleteModal = false">
        <div class="modal confirm-modal" (click)="$event.stopPropagation()">
            <div class="modal-header">
                <h2>X√°c nh·∫≠n x√≥a</h2>
                <button class="close-btn" (click)="showDeleteModal = false">√ó</button>
            </div>
            <div class="modal-body">
                <p>B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ƒë∆°n h√†ng <strong>#{{ orderToDelete?.id }}</strong> kh√¥ng?</p>
                <p class="warning-text">H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.</p>
                <div class="modal-actions">
                    <button class="btn-secondary" (click)="showDeleteModal = false">H·ªßy</button>
                    <button class="btn-danger" (click)="deleteOrder()">X√≥a</button>
                </div>
            </div>
        </div>
    </div>
    }
</div>