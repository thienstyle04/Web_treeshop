<div class="product-detail-page">
    @if (loading()) {
    <div class="loading-container">
        <div class="spinner"></div>
    </div>
    } @else if (product()) {
    <!-- Breadcrumb -->
    <nav class="breadcrumb">
        <a routerLink="/">Trang ch·ªß</a>
        <span>/</span>
        <a routerLink="/products">S·∫£n ph·∫©m</a>
        <span>/</span>
        <span>{{ product()!.name }}</span>
    </nav>

    <div class="product-container">
        <!-- Product Images -->
        <div class="product-images">
            <div class="main-image">
                @if (selectedImage()) {
                <img [src]="selectedImage()" [alt]="product()!.name">
                } @else {
                <img src="assets/images/placeholder-plant.jpg" [alt]="product()!.name">
                }
            </div>
            @if (product()!.imageUrls && product()!.imageUrls.length > 1) {
            <div class="thumbnail-list">
                @for (imageUrl of product()!.imageUrls; track $index) {
                <button class="thumbnail" [class.active]="selectedImage() === imageUrl" (click)="selectImage(imageUrl)">
                    <img [src]="imageUrl" [alt]="product()!.name">
                </button>
                }
            </div>
            }
        </div>

        <!-- Product Info -->
        <div class="product-info">
            <span class="category-tag">{{ product()!.categoryName || 'C√¢y c·∫£nh' }}</span>
            <h1 class="product-name">{{ product()!.name }}</h1>

            @if (product()!.scientificName) {
            <p class="scientific-name">{{ product()!.scientificName }}</p>
            }

            <!-- Rating -->
            <div class="rating-row">
                <div class="stars">
                    @for (star of [1,2,3,4,5]; track star) {
                    <span [class.filled]="star <= averageRating()">‚òÖ</span>
                    }
                </div>
                <span class="rating-text">
                    {{ averageRating() | number:'1.1-1' }} ({{ product()!.reviews?.length || 0 }} ƒë√°nh gi√°)
                </span>
            </div>

            <div class="price-section">
                <span class="price">{{ product()!.price | number:'1.0-0' }}ƒë</span>
            </div>

            <div class="stock-status" [class.in-stock]="product()!.stockQuantity > 0">
                @if (product()!.stockQuantity > 0) {
                <span class="status-icon">‚úì</span> C√≤n h√†ng ({{ product()!.stockQuantity }} s·∫£n ph·∫©m)
                } @else {
                <span class="status-icon">‚úï</span> H·∫øt h√†ng
                }
            </div>

            <div class="description">
                <h3>M√¥ t·∫£</h3>
                <p>{{ product()!.description || 'Ch∆∞a c√≥ m√¥ t·∫£ cho s·∫£n ph·∫©m n√†y.' }}</p>
            </div>

            <!-- Add to Cart -->
            <div class="add-to-cart-section">
                <div class="quantity-selector">
                    <button (click)="decreaseQuantity()" [disabled]="quantity <= 1">-</button>
                    <input type="number" [(ngModel)]="quantity" min="1" [max]="product()!.stockQuantity">
                    <button (click)="increaseQuantity()" [disabled]="quantity >= product()!.stockQuantity">+</button>
                </div>
                <button class="add-to-cart-btn" (click)="addToCart()"
                    [disabled]="product()!.stockQuantity === 0 || isAdding()">
                    @if (isAdding()) {
                    <span class="btn-spinner"></span>
                    ƒêang th√™m...
                    } @else {
                    üõí Th√™m v√†o gi·ªè h√†ng
                    }
                </button>
            </div>

            <div class="product-meta">
                <div class="meta-item">
                    <span class="meta-label">Danh m·ª•c:</span>
                    <a [routerLink]="['/products']" [queryParams]="{category: product()!.categoryId}">
                        {{ product()!.categoryName || 'C√¢y c·∫£nh' }}
                    </a>
                </div>
                <div class="meta-item">
                    <span class="meta-label">Ng√†y th√™m:</span>
                    <span>{{ product()!.dateAdded | date:'dd/MM/yyyy' }}</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Reviews Section -->
    <section class="reviews-section">
        <h2>ƒê√°nh gi√° s·∫£n ph·∫©m</h2>
        <ng-container *ngIf="(product()?.reviews?.length ?? 0) > 0; else noReviews">
            <div class="reviews-list">
                <ng-container *ngFor="let review of product()?.reviews; trackBy: trackById">
                    <div class="review-card">
                        <div class="review-header">
                            <span class="reviewer-name">{{ review.userName }}</span>
                            <div class="review-stars">
                                <ng-container *ngFor="let star of [1,2,3,4,5]">
                                    <span [class.filled]="star <= review.rating">‚òÖ</span>
                                </ng-container>
                            </div>
                        </div>
                        <p class="review-comment">{{ review.comment }}</p>
                        <span class="review-date">{{ review.reviewDate | date:'dd/MM/yyyy' }}</span>
                    </div>
                </ng-container>
            </div>
        </ng-container>
        <ng-template #noReviews>
            <p class="no-reviews">Ch∆∞a c√≥ ƒë√°nh gi√° n√†o cho s·∫£n ph·∫©m n√†y.</p>
        </ng-template>
    </section>
    } @else {
    <div class="not-found">
        <h2>S·∫£n ph·∫©m kh√¥ng t·ªìn t·∫°i</h2>
        <a routerLink="/products">Quay l·∫°i danh s√°ch</a>
    </div>
    }
</div>