<div class="cart-page">
    <div class="page-header">
        <h1>Gi·ªè h√†ng</h1>
    </div>

    <div class="cart-container">
        @if (!isLoggedIn) {
        <div class="empty-cart">
            <span class="empty-icon">üîê</span>
            <h2>Vui l√≤ng ƒëƒÉng nh·∫≠p</h2>
            <p>B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ xem v√† qu·∫£n l√Ω gi·ªè h√†ng</p>
            <a routerLink="/login" [queryParams]="{returnUrl: '/cart'}" class="shop-btn">ƒêƒÉng nh·∫≠p ngay</a>
        </div>
        } @else if (cartService.cartItems().length === 0) {
        <div class="empty-cart">
            <span class="empty-icon">üõí</span>
            <h2>Gi·ªè h√†ng tr·ªëng</h2>
            <p>H√£y th√™m s·∫£n ph·∫©m y√™u th√≠ch v√†o gi·ªè h√†ng</p>
            <a routerLink="/products" class="shop-btn">Mua s·∫Øm ngay</a>
        </div>
        } @else {
        <div class="cart-content">
            <!-- Cart Items -->
            <div class="cart-items">
                <div class="cart-header">
                    <span class="col-product">S·∫£n ph·∫©m</span>
                    <span class="col-price">ƒê∆°n gi√°</span>
                    <span class="col-quantity">S·ªë l∆∞·ª£ng</span>
                    <span class="col-total">Th√†nh ti·ªÅn</span>
                    <span class="col-action"></span>
                </div>

                @for (item of cartService.cartItems(); track item.id) {
                <div class="cart-item">
                    <div class="col-product">
                        <div class="product-image">
                            @if (item.imageUrl) {
                            <img [src]="item.imageUrl" [alt]="item.productName">
                            } @else {
                            <img src="assets/images/placeholder-plant.jpg" [alt]="item.productName">
                            }
                        </div>
                        <div class="product-info">
                            <a [routerLink]="['/products', item.productId]" class="product-name">
                                {{ item.productName }}
                            </a>
                        </div>
                    </div>

                    <div class="col-price">
                        {{ item.price | number:'1.0-0' }}ƒë
                    </div>

                    <div class="col-quantity">
                        <div class="quantity-selector">
                            <button (click)="updateQuantity(item.id, item.quantity - 1)">-</button>
                            <span>{{ item.quantity }}</span>
                            <button (click)="updateQuantity(item.id, item.quantity + 1)">+</button>
                        </div>
                    </div>

                    <div class="col-total">
                        {{ item.price * item.quantity | number:'1.0-0' }}ƒë
                    </div>

                    <div class="col-action">
                        <button class="remove-btn" (click)="removeItem(item.id)">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3 6 5 6 21 6"></polyline>
                                <path
                                    d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2">
                                </path>
                            </svg>
                        </button>
                    </div>
                </div>
                }
            </div>

            <!-- Cart Summary -->
            <div class="cart-summary">
                <h3>T√≥m t·∫Øt ƒë∆°n h√†ng</h3>

                <!-- Discount Code Section -->
                <div class="discount-section">
                    <label>M√£ gi·∫£m gi√°</label>
                    @if (!appliedDiscount) {
                    <button class="select-discount-btn" (click)="openDiscountModal()">
                        üéüÔ∏è Ch·ªçn m√£ gi·∫£m gi√°
                        @if (availableDiscounts().length > 0) {
                        <span class="badge">{{ availableDiscounts().length }}</span>
                        }
                    </button>
                    } @else {
                    <div class="applied-discount">
                        <span class="discount-tag">
                            üéüÔ∏è {{ appliedDiscount?.code }}
                            @if (appliedDiscount?.discountType === 'Percent') {
                            (-{{ appliedDiscount?.value }}%)
                            } @else {
                            (-{{ appliedDiscount?.value | number:'1.0-0' }}ƒë)
                            }
                        </span>
                        <button class="remove-discount" (click)="removeDiscount()">√ó</button>
                    </div>
                    }
                </div>

                <div class="summary-row">
                    <span>T·∫°m t√≠nh</span>
                    <span>{{ cartService.cartTotal() | number:'1.0-0' }}ƒë</span>
                </div>

                @if (appliedDiscount) {
                <div class="summary-row discount">
                    <span>Gi·∫£m gi√°</span>
                    <span>-{{ discountAmount | number:'1.0-0' }}ƒë</span>
                </div>
                }

                <div class="summary-row">
                    <span>Ph√≠ v·∫≠n chuy·ªÉn</span>
                    <span>{{ shippingFee | number:'1.0-0' }}ƒë</span>
                </div>

                @if (cartService.cartTotal() >= 500000) {
                <div class="summary-row discount">
                    <span>Mi·ªÖn ph√≠ v·∫≠n chuy·ªÉn</span>
                    <span>-{{ shippingFee | number:'1.0-0' }}ƒë</span>
                </div>
                }

                <div class="summary-divider"></div>

                <div class="summary-row total">
                    <span>T·ªïng c·ªông</span>
                    <span>{{ finalTotal | number:'1.0-0' }}ƒë</span>
                </div>

                <div class="free-shipping-notice">
                    @if (cartService.cartTotal() < 500000) { <p>üöö Mua th√™m {{ 500000 - cartService.cartTotal() |
                        number:'1.0-0' }}ƒë ƒë·ªÉ ƒë∆∞·ª£c <strong>mi·ªÖn ph√≠ v·∫≠n chuy·ªÉn</strong></p>
                        } @else {
                        <p>üéâ B·∫°n ƒë∆∞·ª£c <strong>mi·ªÖn ph√≠ v·∫≠n chuy·ªÉn!</strong></p>
                        }
                </div>

                <a routerLink="/checkout" class="checkout-btn">
                    Thanh to√°n
                </a>

                <a routerLink="/products" class="continue-shopping">
                    ‚Üê Ti·∫øp t·ª•c mua s·∫Øm
                </a>
            </div>
        </div>
        }
    </div>
</div>

<!-- Discount Modal -->
@if (showDiscountModal()) {
<div class="modal-overlay" (click)="closeDiscountModal()">
    <div class="discount-modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
            <h3>üéüÔ∏è Ch·ªçn m√£ gi·∫£m gi√°</h3>
            <button class="close-btn" (click)="closeDiscountModal()">√ó</button>
        </div>
        <div class="modal-body">
            @if (availableDiscounts().length === 0) {
            <div class="no-discounts">
                <p>Hi·ªán kh√¥ng c√≥ m√£ gi·∫£m gi√° n√†o kh·∫£ d·ª•ng</p>
            </div>
            } @else {
            <div class="discount-list">
                @for (discount of availableDiscounts(); track discount.id) {
                <div class="discount-item" [class.disabled]="cartService.cartTotal() < discount.minimumOrderAmount"
                    (click)="selectDiscount(discount)">
                    <div class="discount-info">
                        <span class="discount-code">{{ discount.code }}</span>
                        <span class="discount-value">
                            @if (discount.discountType === 'Percent') {
                            Gi·∫£m {{ discount.value }}%
                            } @else {
                            Gi·∫£m {{ discount.value | number:'1.0-0' }}ƒë
                            }
                        </span>
                        @if (discount.minimumOrderAmount > 0) {
                        <span class="discount-min">ƒê∆°n t·ªëi thi·ªÉu: {{ discount.minimumOrderAmount | number:'1.0-0'
                            }}ƒë</span>
                        }
                    </div>
                    <div class="discount-action">
                        @if (cartService.cartTotal() >= discount.minimumOrderAmount) {
                        <span class="select-text">Ch·ªçn</span>
                        } @else {
                        <span class="not-eligible">Ch∆∞a ƒë·ªß ƒëi·ªÅu ki·ªán</span>
                        }
                    </div>
                </div>
                }
            </div>
            }
        </div>
    </div>
</div>
}